name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: macos-14
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift 5.10.x
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "5.10"

      - name: Extract version
        run: |
          ref="${GITHUB_REF_NAME}"
          ver="${ref#v}"
          echo "VERSION=${ver}" >> "$GITHUB_ENV"

      - name: Show toolchain
        run: swift --version

      - name: Build (release)
        run: swift build -c release

      - name: Package artifact
        run: |
          os="darwin"
          arch="${RUNNER_ARCH,,}"
          archive="pdf-${VERSION}-${os}-${arch}.tar.gz"
          mkdir -p dist
          cp .build/release/pdf dist/
          cp LICENSE dist/
          tar -C dist -czf "${archive}" .
          echo "ARCHIVE_NAME=${archive}" >> "$GITHUB_ENV"
          ls -lh "${archive}"

      - name: Upload build artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: pdf-${{ runner.os }}-${{ runner.arch }}
          path: ${{ env.ARCHIVE_NAME }}

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: pdf-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  homebrew:
    needs: build-and-release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Publish to Homebrew tap
        uses: Justintime50/homebrew-releaser@v2
        with:
          homebrew_owner: blacktop
          homebrew_tap: homebrew-tap
          formula_folder: Formula
          github_token: ${{ secrets.HOMEBREW_TAP_PAT }}
          install: 'bin.install "pdf"'
          test: 'system "#{bin}/pdf", "--help"'
          target_darwin_arm64: true
          target_darwin_amd64: false
          target_linux_amd64: false
          target_linux_arm64: false
          commit_owner: github-actions[bot]
          commit_email: 41898282+github-actions[bot]@users.noreply.github.com
