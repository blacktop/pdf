name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: macos-14
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Swift 6.1.x
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "6.1.3"

      - name: Show toolchain
        run: swift --version

      - name: Build (release)
        run: swift build -c release

      - name: Package artifact
        run: |
          os=$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')
          arch=${RUNNER_ARCH}
          archive="pdf-${os}-${arch}.tar.gz"
          mkdir -p dist
          cp .build/release/pdf dist/
          cp LICENSE dist/
          tar -C dist -czf "${archive}" .
          echo "ARCHIVE_NAME=${archive}" >> "$GITHUB_ENV"
          ls -lh "${archive}"

      - name: Upload build artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: pdf-${{ runner.os }}-${{ runner.arch }}
          path: ${{ env.ARCHIVE_NAME }}

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: pdf-*.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
