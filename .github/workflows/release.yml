name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Swift 6.x
        uses: swift-actions/setup-swift@v2

      - name: Extract version
        run: |
          ref="${GITHUB_REF_NAME}"
          ver="${ref#v}"
          echo "VERSION=${ver}" >> "$GITHUB_ENV"

      - name: Show toolchain
        run: swift --version

      - name: Build (release)
        run: swift build -c release

      - name: Package artifact
        run: |
          os="darwin"
          arch="${RUNNER_ARCH,,}"
          archive="pdf-${VERSION}-${os}-${arch}.tar.gz"
          mkdir -p dist
          cp .build/release/pdf dist/
          cp LICENSE dist/
          tar -C dist -czf "${archive}" .
          echo "ARCHIVE_NAME=${archive}" >> "$GITHUB_ENV"
          ls -lh "${archive}"

      - name: Upload build artifact (for debugging)
        uses: actions/upload-artifact@v5
        with:
          name: pdf-${{ runner.os }}-${{ runner.arch }}
          path: ${{ env.ARCHIVE_NAME }}

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: pdf-*.tar.gz
          draft: false
          prerelease: false
